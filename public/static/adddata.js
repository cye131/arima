$(document).ready(function(){(function(){var pathname=window.location.pathname;$("#header > .nav-item > a").each(function(){var a=$(this);var link=a.attr("href");if(link==pathname)a.addClass('active')});$("nav.sidebar > ul.nav > li.nav-item > a").each(function(){var a=$(this);var link=a.attr("href");if(link===pathname){a.addClass('active');a.closest('li').css('background-color','#e6e6f0')}})})()});function checkValidSeries(userData){var seriesCount=[];if(userData.length===0){return[]}
$.each(userData,function(k,v){if(v.data!=null)seriesCount.push(k)});return seriesCount}
function isJson(item){item=typeof item!=="string"?JSON.stringify(item):item;try{item=JSON.parse(item)}catch(e){return!1}
if(typeof item==="object"&&item!==null){return!0}
return!1}
function warnAndRedirect(){$('#main').html('<div class="jumbotron jumbotron-fluid">'+'<div class="container">'+'<h1 class="display-3"><a href="/adddata">Please add some data before you can use this tool.</a></h1>'+'</div>'+'</div>')}
function makeCheckboxes(userData,checkOrRadio){var k=0;for(i=1;i<=5;i++){if(userData[i].data==null)continue;if(checkOrRadio==='check'){$('#checkbox-div').append('<div class="custom-control custom-checkbox"><input type="checkbox" class="custom-control-input seriesInput" id="seriesInput'+i+'" data-index="'+i+'" checked><label class="custom-control-label" for="seriesInput'+i+'"><h5><span class="badge badge-secondary" style="background-color:'+(getColorArray())[i]+' ">'+userData[i].info.name+'</span></h5></label></div>')}else{$('#checkbox-div').append('<div class="custom-control custom-radio"><input type="radio" name="seriesInput" class="custom-control-input seriesInput" id="seriesInput'+i+'" data-index="'+i+'" '+(k===0?'checked':'')+'><label class="custom-control-label" for="seriesInput'+i+'"><h5><span class="badge badge-secondary" style="background-color:'+(getColorArray())[i]+' ">'+userData[i].info.name+'</span></h5></label></div>')}
k++}
return}
function getAJAX(model,logic,toScript,fromAjax,timeout){var timerStart=Date.now();$('#overlay').show();return $.ajax({url:'routerAjax.php',type:'POST',data:{model:model,logic:logic,toScript:toScript,fromAjax:fromAjax},dataType:'html',cache:!1,timeout:timeout}).fail(function(res){console.log(res);console.log('AJAX Error')}).always(function(res){$('#overlay').hide();console.log('AJAX Time: '+(Date.now()-timerStart))})}
function getUserData(uniqid){if(uniqid==null||uniqid.length<1)return;return getAJAX([],['get_json_storage'],['userData'],{'uniqid':uniqid},10000)}
function updateSidebar(userData){for(i=1;i<=5;i++){if(userData[i]!=null&&userData[i].data!=null){$('#ser'+i).find('span').removeClass('badge-warning').removeClass('badge-danger').addClass('badge-success').text(userData[i].info.name)}else{$('#ser'+i).find('span').removeClass('badge-warning').removeClass('badge-success').addClass('badge-danger').text('Empty')}}}
function getCookieValue(a){var b=document.cookie.match('(^|;)\\s*'+a+'\\s*=\\s*([^;]+)');return b?b.pop():''}
function getColorArray(){return["#7cb5ec","#434348","#90ed7d","#f7a35c","#8085e9","#f15c80","#e4d354","#2b908f","#f45b5b","#91e8e1"]}
function arrayColumn(array,columnName){return array.map(function(value,index){return value[columnName]})}
function arrayJoinByKey(){for(j=0;j<arguments[0].length;j++){for(var i=0;i<arguments.length;i++){}}};function isValidDate(dateString){var regEx=/^\d{4}-\d{2}-\d{2}$/;if(!dateString.match(regEx))return!1;var d=new Date(dateString);if(!d.getTime()&&d.getTime()!==0)return!1;return d.toISOString().slice(0,10)===dateString}
function validateFail(obj,objStr,str){obj.addClass('is-invalid');objStr.show().text(str)}
function updateCards(userData){for(i=1;i<=5;i++){var card=$('#card'+i);if(card==null)return;var tbl=card.find('table.cardTable');if($.fn.DataTable.isDataTable(tbl)){tbl.DataTable().clear().destroy()}
card.find('div.overlay').hide();if(userData[i]!=null&&userData[i].data!=null){card.removeClass('border-warning').removeClass('border-danger').addClass('border-success').find('div.bs-callout').hide();tbl.show().DataTable({data:userData[i].data,columns:[{title:"Date"},{title:"Corrected Date"},{title:"Value"},{title:"Change"}],columnDefs:[{"targets":[1],"visible":!1}],order:[1,"desc"],pagingType:"full_numbers"});card.find('div.card-header').find('button.card-delete').show().end().find('.card-title').text('#'+i+': '+userData[i].info.name).removeClass('text-danger').removeClass('text-warning').addClass('text-success').end().find('.card-subtitle').html('observations: '+userData[i].info.observations+'</br>time start: '+userData[i].info.obs_start+'</br>time end: '+userData[i].info.obs_end)}else{card.removeClass('border-warning').removeClass('border-success').addClass('border-danger').find('div.bs-callout').show();tbl.hide();card.find('div.card-header').find('button.card-delete').hide().end().find('.card-title').text('Time Series Data #'+i).removeClass('text-success').removeClass('text-warning').addClass('text-danger').end().find('.card-subtitle').html('')}}}
function addCards(){var cardTemplate=$('#card-holder > div.card');for(i=1;i<=5;i++){var newCard=cardTemplate.clone();newCard.attr('id','card'+i).find('form').addClass('cardIndex'+i).find('input.stk-date2').val((new Date()).toISOString().split('T')[0]).end().end().find('table.cardTable').attr('id','cardTable'+i).end().appendTo('#card-holder')}
$('#card-holder > div.card').first().hide()}
function getStkData(uniqid,cardIndex,stkTickerVal,stkFreqVal,stkDate1Val,stkDate2Val){return $.ajax({url:'routerAjax.php',type:'POST',data:{logic:['get_fid_data'],toScript:['userData'],fromAjax:{'uniqid':uniqid,'cardIndex':cardIndex,'lookup_code':stkTickerVal,'freq':stkFreqVal,'min_date':stkDate1Val,'max_date':stkDate2Val}},dataType:'html',cache:!1,timeout:10000}).fail(function(res){console.log(res);console.log('AJAX Error')})}
function deleteUserData(uniqid,cardIndex){if(uniqid==null||uniqid.length<1)return;if(cardIndex==null||cardIndex<1||cardIndex>5)return;return $.ajax({url:'routerAjax.php',type:'POST',data:{logic:['delete_json_storage'],toScript:['deletedBytes','userData'],fromAjax:{'uniqid':uniqid,'cardIndex':cardIndex}},dataType:'html',cache:!1,timeout:10000}).fail(function(res){console.log(res);console.log('AJAX Error')})};$(document).ready(function(){addCards();(function(){var uniqid=getCookieValue('uniqid');if(uniqid==null)return;var ajaxGetUserData=getUserData(uniqid);ajaxGetUserData.done(function(res){userData=JSON.parse(res).userData;updateCards(userData);updateSidebar(userData)})})();$(".addbtn").click(function(){var modal=$(this).next('div.modal');modal.modal('show')});$('.stk-input').keyup(function(){var str=$(this).val();str=str.replace(/[^a-zA-Z .-]+/g,'').toUpperCase();$(this).val(str)});$('.stk-submit').click(function(){var form=$(this).closest('form');form.find('.is-invalid').removeClass('is-invalid');form.find('div.invalid-feedback').hide().text('');var stkTicker=form.find('.stk-ticker');var stkTickerVal=stkTicker.val();var stkDate1=form.find('input.stk-date1');var stkDate1Val=stkDate1.val();var stkDate2=form.find('.stk-date2');var stkDate2Val=stkDate2.val();var stkFreq=form.find('input[type="radio"][name="stk-freq"]:checked');var stkFreqVal=stkFreq.val();stkTickerVal=stkTickerVal.toUpperCase();if(typeof(stkTickerVal)!=='string'||stkTickerVal.length<1){validateFail(stkTicker,form.find('div.invalid-feedback'),'Please enter in a stock ticker.');return}
if(typeof(stkDate1Val)!=='string'||isValidDate(stkDate1Val)===!1){validateFail(stkDate1,form.find('div.invalid-feedback'),'Incorrect date format. Date must typed be in YYYY-MM-DD.');return}
if(typeof(stkDate2Val)!=='string'||isValidDate(stkDate2Val)===!1){validateFail(stkDate2,form.find('div.invalid-feedback'),'Incorrect date format. Date must typed be in YYYY-MM-DD.');return}
var d1=new Date(stkDate1Val);var d2=new Date(stkDate2Val);if(d1<new Date('1980-01-01')||d1>new Date()){validateFail(stkDate1,form.find('div.invalid-feedback'),'Please do not enter dates before than 1980-01-01 or after '+(new Date()).toISOString().split('T')[0]);return}
if(d2<new Date('1980-01-01')||d2>new Date()){validateFail(stkDate2,form.find('div.invalid-feedback'),'Please do not enter dates before than 1980-01-01 or after '+(new Date()).toISOString().split('T')[0]);return}
if(d1>=d2){validateFail(stkDate1,form.find('div.invalid-feedback'),'.');validateFail(stkDate2,form.find('div.invalid-feedback'),'End date must be later than start date!');return}
console.log(stkFreq.val());$('.stock-input').addClass('is-valid');var objClasses=form.attr('class');var placeIndex=objClasses.indexOf('cardIndex');if(placeIndex<0)return;var cardIndex=objClasses.substring(placeIndex+9,placeIndex+10);var uniqid=getCookieValue('uniqid');if(uniqid.length<1)return;console.log('Getting AJAX');form.prev('div.overlay').show();var ajaxGetStkData=getStkData(uniqid,cardIndex,stkTickerVal,stkFreqVal,stkDate1Val,stkDate2Val);ajaxGetStkData.done(function(res){form.closest('div.modal').modal('hide').find('div.overlay').show();console.log(res);userData=JSON.parse(res).userData;updateCards(userData);updateSidebar(userData)})});$('button.card-delete').click(function(){var cardID=$(this).closest('div.card').attr('id');var placeIndex=cardID.indexOf('card');if(placeIndex<0)return;var cardIndex=cardID.substring(placeIndex+4,placeIndex+5);console.log(cardIndex);var uniqid=getCookieValue('uniqid');var ajaxDeleteUserData=deleteUserData(uniqid,cardIndex);ajaxDeleteUserData.done(function(res){res=JSON.parse(res);if(res.deletedBytes==null||res.deletedBytes<1)return;updateCards(res.userData);updateSidebar(res.userData)})})})